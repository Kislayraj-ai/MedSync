{% extends layout_path %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title }} {% endblock %}

{% block vendor_css %}
{{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
  <link rel="stylesheet" href="{% static "assets/css/common.css" %}">

  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock vendor_css %}



{% block content %}

<div class="container-fluid px-0">
  <div class="row justify-content-center">
    <div class="col-lg-15 col-xl-12">
      <div class="card card-modern">
        <div class="card-body p-4 p-md-5">

              <!-- Header -->
              <div class="d-flex align-items-center justify-content-between mb-4">
                  <h3 class="section-title mb-0">{{ page_title }}</h3>
                  <a href="{% url 'add_appointment'  %}" class="btn btn-outline-secondary">Appointment Calendar</a>
              </div>


                {% for msg in messages %}
                {% if msg.tags == "success" %}
                    <div class="alert alert-success">
                {% elif msg.tags == "error" %}
                    <div class="alert alert-danger">
                {% else %}
                    <div class="alert alert-info">
                {% endif %}
                    {{ msg }}
                    </div>
                {% endfor %}

            {% comment %} Main Form Here {% endcomment %}
            <form method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="row g-4">

                <div class="row g-4">

                  {% comment %} for the image {% endcomment %}
                  <div class="col-md-10 text-center mb-4">
                    <label for="profile_img" class="d-inline-block position-relative" style="cursor: pointer;">

                        <!-- Circle Avatar -->
                        <div class="rounded-circle border d-flex align-items-center justify-content-center" 
                            style="width: 120px; height: 120px; background-color: #f8f9fa; overflow: hidden;">
                        <img id="profile_preview" 
                            src="{% if patientprofile and patientprofile.profile_img %}{{ patientprofile.profile_img.url }}{% else %}https://via.placeholder.com/120x120?text=+{% endif %}" 
                            alt="Profile" 
                            class="img-fluid" 
                            style="object-fit: cover; width: 100%; height: 100%;">
                        </div>

                        <!-- Plus Sign Overlay -->
                        <div class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                            style="width: 35px; height: 35px; font-size: 20px; border: 2px solid #fff;">
                        +
                        </div>
                    </label>
                    
                    <!-- Hidden File Input -->
                    <input type="file" name="profile_img" id="profile_img" class="d-none" accept="image/*" 
                            onchange="previewProfileImage(event)">
                    <div class="form-text">Please upload image</div>
                    </div>


                <input type="hidden" name="user_id" value="{{ paientdata.id }}">
                <input type="hidden" name="appointment_id" value="{{ appointment.id }}">

                      <div class="col-md-6">
                        <label for="appdate">Appointment Date</label>
                        {% comment %} <select name="appdate" id="appdate" class='form-control'>
                        </select> {% endcomment %}
                        <input type="text" name="appdate" id="appdate" class='form-control' value="{{ appointment.appdate|date:"Y-m-d" }}" required readonly />
                      </div>

                    <div class="col-md-6">
                      <label for="apptime">Appointment Time</label>
                      <select name="apptime" id="apptime" class='form-control'>
                      </select>
                    </div>



                  {% for field in user_form %}
                  
                      {% if field.name != "username"  or field.name != "p_age" %}
                        <div class="col-md-6">
                          <label class="form-label">{{ field.label }}</label>
                          {{ field }}
                          {{ field.errors }}
                        </div>
                      {% endif %}
                    {% endfor %}
                    
                  <div class="col-md-6">
                    <label class="form-label">Doctor</label>
                    <select name="doctor" id="doctor" class="form-control"></select>
                  </div>

                  {% for field in profile_form  %}
                    {% if field.name != "profile_img" %}
                      <div class="col-md-6">
                          <label class="form-label">{{ field.label }}</label>
                          {{ field }}
                          {{ field.errors }}
                      </div>
                    {% endif %}
                  {% endfor %}

              </div>

              <div class="d-flex justify-content-end gap-2 pt-4 mt-4 border-top">
                <a class="btn btn-outline-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Update Patient</button>
              </div>
            </form>


        </div>  
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block vendor_js %}
  {{ block.super }}
    <script src="{% static 'js/dashboards-analytics.js' %}"></script>
{% endblock vendor_js %}

{% block page_js %}

{{block.super}}

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>

          function previewProfileImage(event) {
            const reader = new FileReader();
            reader.onload = function () {
              document.getElementById('profile_preview').src = reader.result;
            }
            reader.readAsDataURL(event.target.files[0]);
          }


  $(document).ready(()=>{
        let GET_BASE_URL = "{{ BASE_URL }}";;
        let doctorid=  "{{appointment.doctor.id}}";
        let appdate=  "{{ appointment.appdate|date:"Y-m-d"  }}";
        let apptime = "{{ appointment.apptime|time:"H:i"  }}" ;
        let clinicid=  "{{appointment.doctor.doctor_profile.first.clinic_id}}" ;
        // console.log("getclinicid " , clinicid)
        {% comment %} console.log("Getappdate" , appdate ) {% endcomment %}
      

        $('#apptime').select2({
            placeholder : 'Choose app time' ,
            width: '100%' ,
        })

        $('#doctor').select2({
            placeholder : 'Choose Doctor' ,
            width: '100%' ,
        })

        const fetchDoctor = () =>{

            $.ajax({
                url : `${GET_BASE_URL}/api/v1/doctors` ,
                type : "GET" ,
                data : { clinicid: parseInt(clinicid)  } ,
                success : (data) =>{

                  $('#doctor').empty();

                    console.log(data)
                    data.forEach((item) => {
                        if (parseInt(doctorid) === item.id) {
                            $('#doctor').append(
                                new Option(`${item.first_name} ${item.last_name}`, item.id, false, false)
                            );
                        }
                    });

                    
                   // console.log("GEtdata " , doctorid)
                    $('#doctor').val(parseInt(doctorid)).trigger('change')
                    // $('#doctor').select2()
                }
            })
        }

        
        const fetchAvailSlots = ()=>{

          $.ajax({
                url : `${GET_BASE_URL}/api/v1/get-available-clinic-slots` ,
                type : "GET" ,
                data :{
                  clinicid , doctorid ,
                  date : appdate ,
                  // time: seletedtime
                  apptime
                },
                success : (response)=>{
                  //console.log("Get result " , response)
                      $('#apptime').empty();
                      $('#apptime').append(
                            new Option("Select time", 0 , false, false)
                      )
                      response.available.forEach((item)=>{
                        $('#apptime').append(
                            new Option(item , item, false, false)
                        )
                    })

                    $('#apptime').val(apptime).trigger('change')
                }
          })
        }
        
        fetchAvailSlots()

      fetchDoctor()

    })


  </script>
{% endblock  %}